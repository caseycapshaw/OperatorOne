# docker-compose.dev.yml
# Local development overrides - disables TLS, exposes service ports directly
#
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d

services:
  traefik:
    image: traefik:v3.6
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-logs:/var/log/traefik
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=op1-frontend"
      - "--entrypoints.web.address=:80"
      - "--log.level=DEBUG"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--accesslog.format=json"
      - "--ping=true"
    ports:
      - "80:80"
      - "8080:8080"  # Traefik dashboard
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=web"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.tls=false"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver="
      - "traefik.http.routers.traefik-dashboard.middlewares="

  # Override all routers to use HTTP (must clear TLS and middleware labels from base)
  n8n:
    environment:
      - N8N_SECURE_COOKIE=false
      # Disable external hooks in dev (bind mount causes macOS Docker -35 errors)
      - EXTERNAL_HOOK_FILES=
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`automation.localhost`)"
      - "traefik.http.routers.n8n.entrypoints=web"
      - "traefik.http.routers.n8n.tls=false"
      - "traefik.http.routers.n8n.tls.certresolver="
      - "traefik.http.routers.n8n.middlewares="
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
      - "traefik.docker.network=op1-frontend"

  authentik-server:
    environment:
      - AUTHENTIK_BOOTSTRAP_TOKEN=dev-bootstrap-token
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authentik.rule=Host(`auth.localhost`)"
      - "traefik.http.routers.authentik.entrypoints=web"
      - "traefik.http.routers.authentik.tls=false"
      - "traefik.http.routers.authentik.tls.certresolver="
      - "traefik.http.services.authentik.loadbalancer.server.port=9000"
      - "traefik.docker.network=op1-frontend"

  authentik-worker:
    environment:
      - AUTHENTIK_BOOTSTRAP_TOKEN=dev-bootstrap-token

  grafana:
    environment:
      - GF_SERVER_ROOT_URL=http://monitor.localhost
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=http://auth.localhost/application/o/authorize/
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=http://authentik-server:9000/application/o/token/
      - GF_AUTH_GENERIC_OAUTH_API_URL=http://authentik-server:9000/application/o/userinfo/
      - GF_AUTH_GENERIC_OAUTH_REDIRECT_URL=http://monitor.localhost/login/generic_oauth
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`monitor.localhost`)"
      - "traefik.http.routers.grafana.entrypoints=web"
      - "traefik.http.routers.grafana.tls=false"
      - "traefik.http.routers.grafana.tls.certresolver="
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
      - "traefik.docker.network=op1-frontend"
