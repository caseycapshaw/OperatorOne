# modules/console/docker-compose.yml
# OperatorOne Console

services:
  console:
    build:
      context: ./modules/console/app
      dockerfile: Dockerfile
    container_name: op1-console
    restart: unless-stopped
    volumes:
      - ../../.env:/opt/op1/.env
    environment:
      - DATABASE_URL=postgresql://console:${POSTGRES_CONSOLE_PASSWORD}@postgres:5432/console
      - AUTH_SECRET=${CONSOLE_AUTH_SECRET}
      - AUTH_TRUST_HOST=true
      - AUTH_URL=https://console.${DOMAIN}
      - AUTH_AUTHENTIK_ID=${CONSOLE_OAUTH_CLIENT_ID}
      - AUTH_AUTHENTIK_SECRET=${CONSOLE_OAUTH_CLIENT_SECRET}
      - AUTH_AUTHENTIK_ISSUER=https://auth.${DOMAIN}/application/o/console/
      # AI Agent
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # OpenBao secrets management
      - OPENBAO_ADDR=http://openbao:8200
      - OPENBAO_SERVICE_TOKEN=${OPENBAO_SERVICE_TOKEN}
      - AI_MODEL=${AI_MODEL:-claude-sonnet-4-5-20250929}
      - N8N_API_URL=http://op1-n8n:5678/api/v1
      - N8N_API_KEY=${N8N_API_KEY}
      - ADMIN_MCP_URL=http://admin-mcp-server:3000
      - ADMIN_MCP_TOKEN=${APPROVAL_API_TOKEN}
      # Paperless-ngx document management
      - PAPERLESS_API_URL=${PAPERLESS_API_URL:-http://op1-paperless:8000/api}
      - PAPERLESS_API_TOKEN=${PAPERLESS_API_TOKEN}
      - PAPERLESS_URL=https://docs.${DOMAIN}
      # Setup wizard
      - SETUP_ENV_PATH=/opt/op1/.env
      - AUTHENTIK_BOOTSTRAP_PASSWORD=${AUTHENTIK_BOOTSTRAP_PASSWORD}
      - AUTHENTIK_BOOTSTRAP_TOKEN=${AUTHENTIK_BOOTSTRAP_TOKEN}
      - AUTHENTIK_API_URL=https://auth.${DOMAIN}
      - DOMAIN=${DOMAIN}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - op1-backend
      - op1-frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.console.rule=Host(`console.${DOMAIN}`)"
      - "traefik.http.routers.console.entrypoints=websecure"
      - "traefik.http.routers.console.tls.certresolver=letsencrypt"
      - "traefik.http.routers.console.middlewares=web-chain@file"
      - "traefik.http.services.console.loadbalancer.server.port=3000"
      - "traefik.docker.network=op1-frontend"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  op1-frontend:
    external: true
  op1-backend:
    external: true
